name: Tests & Coverage

on:
  workflow_run:
    workflows: ["Code Quality Check"]
    types:
      - completed

jobs:
  run-tests:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Prepare environment files
        run: |
          # Create .env.test if needed
          cp envs/.env.test.example envs/.env.test || true
          echo "âœ… Environment files ready"

      - name: Run tests with coverage
        env:
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SECRET_KEY }}
          SUPABASE_AUTH_TEST_PASSWORD: ${{ secrets.SUPABASE_AUTH_TEST_PASSWORD }}
        run: |
          echo "ðŸ§© Running pytest inside container..."
          make tests-ci

      - name: Upload coverage as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml